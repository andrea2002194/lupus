<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lupus Mobile</title>
<link rel="stylesheet" href="stile.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0ea5a4">
</head>
<body>
<div class="app" role="application" aria-label="Lupus Mobile">
  <h1 class="mainTitle">LUPUS MOBILE</h1>

<!-- START -->
<div id="startSection" class="section">
   <div id="playerCountSection" class="section">
  <div class="card">
    <strong>Scegli il numero di giocatori:</strong>
  </div>
  <div class="row"></div> <!-- qui metti i pulsanti 7-12 -->
</div>

<!-- INPUT EXTRA E PULSANTE INIZIA FUORI -->
<div id="extraPlayersDiv" class="row" style="display:none; margin-top:10px;"></div>
<button id="startBtn" class="primary" style="margin-top:10px; display:none;">INIZIA</button>

<!-- SEZIONE RUOLI CON AZIONI -->
<div id="roleInfoSection" class="section" style="display:none">
  <div class="card" id="roleInfoCard">
    <h2>Ruoli presenti in questa partita</h2>
    <ul id="roleList"></ul>
  </div>
  <div class="row" style="margin-top:10px; gap: 10px;">
    <button id="confirmRolesBtn" class="primary">INIZIA LA PARTITA</button>
  </div>
</div>

  <!-- NOTTE -->
  <div id="nightSection" class="section" style="display:none">
    <div class="card" style="width:100%;max-width:720px;">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>üåô NOTTE <span id="nightNum">1</span></strong></div>
        <div id="nightState" class="muted">Fase: primo giro</div>
      </div>
      <div id="playersArea" class="row"></div>
      <div id="actionArea" class="row"></div>
      <div id="timerDiv"></div>
    </div>
  </div>

  <!-- RECAP NOTTE -->
  <div id="recapNightSection" class="section" style="display:none">
    <div class="card" id="recapNightCard"></div>
    <div class="row" style="margin-top:10px">
      <button id="continueToDayBtn" class="primary">Continua al Giorno</button>
    </div>
  </div>

  <!-- GIORNO -->
  <div id="daySection" class="section" style="display:none">
    <div class="card" style="width:100%;max-width:720px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>üå§Ô∏è GIORNO <span id="dayNum">1</span></strong></div>
        <div id="dayState" class="muted">CLICCA IL TUO NOME</div>
      </div>
      <div id="playersDay" class="row" style="margin-top:10px"></div>
      <div id="voteArea" class="row"></div>
      <div id="voteInfo" class="muted" style="margin-top:8px"></div>
      <div class="row" style="margin-top:10px">
        <button id="btnCalcolaVoti" class="primary" style="display:none">Calcola voti</button>
      </div>
    </div>
  </div>

  <!-- RECAP ROGO -->
  <div id="recapRogoSection" class="section" style="display:none">
    <div class="card" id="recapRogoCard"></div>
    <div class="row" style="margin-top:10px">
      <button id="continueToNightBtn" class="primary">Continua alla Notte</button>
    </div>
  </div>
</div>
<!-- LOG -->
<div id="logContainer">
  <h2>üìù Log di gioco</h2>
  <div id="logContent"></div>
</div>

<!-- FINE PARTITA -->
<div id="endGameScreen" class="end-game hidden">
    <div id="winnerBox"></div>
    <div id="finalLog"></div>
    <button id="restartBtn">RICOMINCIA PARTITA</button>
</div>

<script>

//=====================
//	Stato e configurazione
//=====================

const ruoloVillico = ["VEGGENTE","MEDIUM","GUFO","VILLICO","MASSONE","JOKER"];

const ruoliMannari = ["LUPO","LUPO ALFA","L'INDEMONIATO","MERETRICE","CRICETO"];

const ruoloBuoni = ["VEGGENTE","MEDIUM","MERETRICE","GUFO","MASSONE","VILLICO"];

const ruoloCattivi = ["LUPO","LUPO ALFA","JOKER"];

let players = [];
let nightNum = 1, dayNum = 1;
let silenziato = null;
let protezioni = {};
let azioni = {};       // azioni registrate (LUPO, VEGGENTE, ecc.)
let gufato = null;     // bersaglio corrente del GUFO e nome gufato (se presente)
let mortiFaseNotte = []; // morti registrati notte corrente
let graveLog = [];     // storico morti
let nightPlayersSnapshot = []; // copia dei giocatori all'inizio della notte
const actionRoles = ['JOKER','MERETRICE','GUFO','VEGGENTE','LUPO'];
let JOKER, MERETRICE, VEGGENTE, GUFO, LUPO;
const ruoloDescrizioni = {
    "JOKER": "PU√í SILENZIARE UN ALTRO GIOCATORE OGNI NOTTE. SE INDICA IL PROTETTO DALLA MERETRICE IL SUO EFFETTO NON VALE.",
    "MERETRICE": "PROTEGGE UN GIOCATORE DA OGNI AZIONE SUBITA DURANTE LA NOTTE. SE DURANTE LA NOTTE VIENE UCCISA DAL LUPO PORTA CON S√â ANCHE IL PROTETTO.",
    "LUPO": "UCCIDE UN GIOCATORE DI NOTTE. SE IN PRESENZA DEL LUPO ALFA RIMANE INERME FINCH√â QUEST'ULTIMO √à VIVO.",
    "LUPO ALFA": "DECIDE CON I LUPI CHI ATTACCARE. SE VIVO AGISCE PER CONTO DEI LUPI DURANTE LA NOTTE.",
    "GUFO": "SCOPRE SE UN GIOCATORE √à UN MANNARO. IN CASO DI INDECISIONE PER IL ROGO LA PERSONA GUFATA HA 1 VOTO IN PI√ô.",
    "VEGGENTE": "SCOPRE IL RUOLO DI UN GIOCATORE DURANTE LA NOTTE.",
    "MEDIUM": "SA CHI √à MORTO AL ROGO DURANTE LA NOTTE.",
    "CRICETO": "IMMUNE AGLI ATTACCHI DEI LUPI. RUBA LA VITTORIA SE ALLA FINE √à ANCORA VIVO.",
    "VILLICO": "GIOCA NORMALMENTE E NON FA AZIONI.",
    "L'INDEMONIATO": "SA CHI SONO I LUPI.",
    "MASSONE": "SA CHI √à L'ALTRO MASSONE."
};

// Votazione / ballottaggio
let phase = 'night_first'; // night_first, night_second, recap_night, day_first, day_secondBallot, recap_rogo
let ballotaggio = [];      // array candidati in ballottaggio
let inSecondBallot = false;
let votiGiorno = {};       // map voter -> target
let vincitorePrimo = null; // nome vincitore primo sondaggio quando unico
let ultimoRogo = null;
let currentVoter = null;

//=====================
//	AGGIUNTA PER 8 GIOCATORI
//=====================
const startBtn = document.getElementById('startBtn');
const playerCountSection = document.getElementById("playerCountSection");
const extraPlayersDiv = document.getElementById("extraPlayersDiv");
let selectedPlayerCount = 7;

const allNames = ["ANDREA","VALE","MATTIA","DAIANA","MATTEO","GIULIA","MICHAEL"];
let names = []; // Lista giocatori definitiva

const playerRow = playerCountSection.querySelector('.row');

[7,8,9,10,11,12].forEach(n => {
    const btn = document.createElement('button');
    btn.className = 'primary';
    btn.textContent = `${n} Giocatori`;
    
btn.onclick = () => {
    selectedPlayerCount = n;

    // üîí NASCONDE SOLO I BOTTONI DEI NUMERI
    playerCountSection.querySelector('.row').style.display = 'none';
    playerCountSection.querySelector('.card').style.display = 'none';

    // MOSTRA INPUT EXTRA SOLO SE NECESSARIO
    if (n > 7) {
        extraPlayersDiv.style.display = 'flex';
        createExtraInputs(n);
    } else {
        extraPlayersDiv.style.display = 'none';
    }

    // MOSTRA PULSANTE INIZIA
    startBtn.style.display = 'block';
};

    // aggiungi il pulsante alla riga dei numeri
    playerRow.appendChild(btn);
});

//=====================
//	Elementi UI
//=====================

const nightSection = document.getElementById('nightSection');
const nightNumEl = document.getElementById('nightNum');
const nightState = document.getElementById('nightState');
const playersArea = document.getElementById('playersArea');
const actionArea = document.getElementById('actionArea');
const timerDiv = document.getElementById('timerDiv');

const recapNightSection = document.getElementById('recapNightSection');
const recapNightCard = document.getElementById('recapNightCard');
const continueToDayBtn = document.getElementById('continueToDayBtn');

const daySection = document.getElementById('daySection');
const playersDay = document.getElementById('playersDay');
const voteArea = document.getElementById('voteArea');
const voteInfo = document.getElementById('voteInfo');
const dayNumEl = document.getElementById('dayNum');
const btnCalcolaVoti = document.getElementById('btnCalcolaVoti');
const lupoAlfa = players.find(p => p.role === "LUPO ALFA" && p.alive);
const lupoNormale = players.find(p => p.role === "LUPO" && p.alive);
const recapRogoSection = document.getElementById('recapRogoSection');
const recapRogoCard = document.getElementById('recapRogoCard');
const continueToNightBtn = document.getElementById('continueToNightBtn');
const MSG_NO_ACTION = "NON HAI POTUTO FARE L'AZIONE";
const MSG_NO_INFO = "NON HO INFORMAZIONE PER TE";
const MSG_NO_DEAD_AT_ROGO = "NESSUNO √à MORTO AL ROGO";
const MSG_ACTION = "hai agito indisturbato";
const baseRoles = ["JOKER","MERETRICE","LUPO","GUFO","VEGGENTE","MEDIUM","CRICETO"];

const DAY_TEXT = {
    SELECT_PLAYER: "CLICCA IL TUO NOME",
    ACTIONS: "FASE: AZIONI",
    VOTO: "FASE: VOTO"
};

//=====================
//	Utility
//=====================

function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
function findPlayer(name){ return players.find(p=>p.name===name); }
function alivePlayers(){ return players.filter(p=>p.alive); }
function updateTitles(){ nightNumEl.textContent = nightNum; dayNumEl.textContent = dayNum; }

//=====================
//	ASSEGNAZIONE RUOLI RANDOM
//=====================

function assignRoles(){
  const shuffled = shuffle(baseRoles.slice());
  players = names.map((n,i)=>({name:n,role:shuffled[i],alive:true,acted:false}));
  // reset stati
  silenziato = null; protezioni = {}; azioni = {}; gufato = null; mortiFaseNotte = []; graveLog = [];
  phase = 'night_first'; ballotaggio=[]; inSecondBallot=false; votiGiorno={}; gufato=null; vincitorePrimo=null;
  updateTitles();
}

//=====================
//	VITE DEI GIOCATORI
//=====================

players = names.map((n,i)=>({
    name: n,
    role: shuffled[i],
    alive: true,
    acted: false,
    lives: 1   // default 1 vita
}));

// Imposta vite speciali
players.forEach(p => {
    if(p.role === "VILLICO" && players.length >= 10) p.lives = 2;
});

//=====================
//	AGGIUNTA PULSANTI PER EXTRA PLAYER
//=====================

function createExtraInputs(count){
    extraPlayersDiv.innerHTML = '';
    for(let i = 8; i <= count; i++){
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `Nome ${i}¬∞ giocatore`;
	input.style = `
	  text-transform:uppercase;
	  width: 100%;
	  max-width: 400px
	  padding:10px;
	  border-radius:8px;
	  border:none;
	  font-weight:bold;
	`;

        input.oninput = () => input.value = input.value.toUpperCase();
        extraPlayersDiv.appendChild(input);
    }
}

//=====================
//	ASSEGNAZIONE RUOLI IN BASE A QUANTI PLAYER  
//=====================

function setupRolesByPlayerCount(count){
    // reset baseRoles tranne LUPO
    baseRoles.length = 0;
    baseRoles.push("JOKER","MERETRICE","LUPO","GUFO","VEGGENTE","MEDIUM","CRICETO");

    if(count >= 8) baseRoles.push("VILLICO");
    if(count >= 9) baseRoles.push("L'INDEMONIATO");

    if(count >= 10) {
        baseRoles.push("LUPO ALFA");
        if(!actionRoles.includes("LUPO ALFA")) actionRoles.push("LUPO ALFA");

        // rimuovo il LUPO normale se presente
        const i = actionRoles.indexOf("LUPO");
        if(i !== -1) actionRoles.splice(i,1);
    }

    if(count >= 11){
        baseRoles.push("MASSONE","MASSONE");
        const i = baseRoles.indexOf("VILLICO");
        if(i !== -1) baseRoles.splice(i,1);
    }

    if(count === 12){
        baseRoles.push("VILLICO");
    }
}

//=====================
//	STAMPATA SUL LOG DEI RUOLI ASSOCIATI AL NOME
//=====================

function logRoleDistribution() {
    log('üé≤ Distribuzione iniziale dei ruoli:');
    players.forEach(p => log(`- ${p.name}: ${p.role}`));
}

//=====================
//	FASE 1 NOTTE: LOGICA CHE GESTISCE LA RIVELAZIONE DEI RUOLI E DELLE AZIONI
//=====================

function renderNightFirst() {
    phase = 'night_first';
    nightSection.style.display = 'block';
    recapNightSection.style.display = 'none';
    daySection.style.display = 'none';
    recapRogoSection.style.display = 'none';

    nightState.textContent = DAY_TEXT.SELECT_PLAYER;
    playersArea.innerHTML = '';
    actionArea.innerHTML = '';
    timerDiv.textContent = '';

    // Trova i giocatori vivi che devono ancora agire
    const toAct = players.filter(p => p.alive && !p.acted);

    // Se nessuno deve agire ‚Üí passa al secondo giro
    if (toAct.length === 0) {
        setTimeout(startNightSecond, 200);
        return;
    }

    // Mostra pulsanti dei giocatori che devono agire
    toAct.forEach(p => {
        const btn = document.createElement('button');
        btn.className = 'playerBtn';
        btn.textContent = p.name;
        btn.onclick = () => showRoleForPlayer(p);
        playersArea.appendChild(btn);
    });
}

//=====================
//	FASE 1 NOTTE: UI CHE GESTISCE LA RIVELAZIONE DEI RUOLI E DELLE AZIONI
//=====================

function showRoleForPlayer(player) {
    // Pulizia UI
    playersArea.innerHTML = '';
    actionArea.innerHTML = '';
    timerDiv.textContent = '';

    // üîπ Card con ruolo (sempre!)
    const roleCard = document.createElement('div');
    roleCard.className = 'card';
    roleCard.innerHTML = `<strong>${player.name}</strong><br/>Ruolo: <strong>${player.role}</strong>`;
    actionArea.appendChild(roleCard);

    // =====================
    // MASSONE
    // =====================
    if (player.role === "MASSONE") {
        const altriMassoni = players.filter(p => p.role === "MASSONE" && p.name !== player.name && p.alive);
        const reveal = document.createElement('div');
        reveal.className = 'card';
        reveal.innerHTML = altriMassoni.length > 0
            ? `ü§ù L'ALTRO MASSONE √à: <strong>${altriMassoni.map(p => p.name).join(', ')}</strong>`
            : 'ü§ù L‚ÄôALTRO MASSONE √à MORTO';
        actionArea.appendChild(reveal);

        const btn = document.createElement('button');
        btn.className = 'primary';
        btn.textContent = 'Continua';
        btn.onclick = () => { player.acted = true; renderNightFirst(); };
        actionArea.appendChild(btn);
        return; // MASSONE non fa altre azioni
    }

    // =====================
    // L'INDEMONIATO
    // =====================
    if (player.role === "L'INDEMONIATO") {
        const lupi = players.filter(p => p.role === "LUPO" || p.role === "LUPO ALFA");
        const reveal = document.createElement('div');
        reveal.className = 'card';
        reveal.innerHTML = lupi.length > 0
            ? `üê∫ <strong>LUPI IN PARTITA:</strong><br/>${lupi.map(p => p.name).join(', ')}`
            : 'üê∫ NESSUN LUPO IN PARTITA';
        actionArea.appendChild(reveal);

        const btn = document.createElement('button');
        btn.className = 'primary';
        btn.textContent = 'Continua';
        btn.onclick = () => { player.acted = true; renderNightFirst(); };
        actionArea.appendChild(btn);
        return; // L'INDEMONIATO non fa altre azioni
    }
    // =====================
    // LUPI 
    // =====================

if (player.role === "LUPO") {
    const lupi = players.filter(p => (p.role === "LUPO" || p.role === "LUPO ALFA") &&
        p.name !== player.name && p.alive
    );

    const reveal = document.createElement('div');
    reveal.className = 'card';
    reveal.innerHTML = `üê∫ <strong>LUPO ALFA IN PARTITA:</strong><br/>${lupi.map(p => 
        p.role === "LUPO ALFA" ? `${p.name} <strong>(NON PUOI AGIRE)</strong>` : p.name
    ).join(', ')}`;

    actionArea.appendChild(reveal);
}

if (player.role === "LUPO ALFA") {

    if (playersArea.querySelector('.revealCard')) return;

    const lupi = players.filter(p => p.role === "LUPO" && p.alive);

    const reveal = document.createElement('div');
    reveal.className = 'card revealCard';
    reveal.innerHTML = `üê∫ <strong>L'ALTRO LUPO √à:</strong><br/>${lupi.map(p => p.name).join(', ')}`;

    playersArea.appendChild(reveal); // üëà SOTTO IL RUOLO
}

    // =====================
    // Ruoli con azione
    // =====================
    if (actionRoles.includes(player.role) && player.alive && players.some(t => t.alive && t.name !== player.name)) {
        showActionOptions(player); // selezione target
        // non serve return, la card rimane sopra i pulsanti
    } else {
        // =====================
        // Ruoli senza azione
        // =====================
        const btn = document.createElement('button');
        btn.className = 'primary';
        btn.textContent = 'Continua';
        btn.onclick = () => { 
            player.acted = true; 
            renderNightFirst(); 
        };
        actionArea.appendChild(btn);
    }
}

//=====================
//	FASE 2 NOTTE : UI DELLA FASE IN CUI DA LE INFORMAZIONI
//=====================

function renderNightSecond() {
    phase = 'night_second';
    nightState.textContent = DAY_TEXT.SELECT_PLAYER;
    playersArea.innerHTML = '';
    actionArea.innerHTML = '';
    timerDiv.textContent = '';

    // Mostra tutti i giocatori nello snapshot (anche se morti)
    const toAct = nightPlayersSnapshot.filter(p => !p.acted);

    if (toAct.length === 0) {
        // Nessuno rimasto ‚Üí mostra recap notte
        showNightRecap();
        return;
    }

    // Pulsanti per ciascun giocatore
    toAct.forEach(p => {
        const btn = document.createElement('button');
        btn.className = 'playerBtn';
        btn.textContent = p.name;
        btn.onclick = () => showSecondInfoFor(p);
        playersArea.appendChild(btn);
    });
}

//=====================
//	FASE 1 NOTTE : UI DELLA FASE IN CUI SELEZIONI IL BERSAGLIO
//=====================

function showActionOptions(player) {
    actionArea.innerHTML = '';
    nightState.textContent = DAY_TEXT.ACTIONS;

    // üîπ Mantieni la card se esiste
    
    let roleCard = playersArea.querySelector('.roleCard');
    if (!roleCard) {
        roleCard = document.createElement('div');
        roleCard.className = 'card roleCard';
        roleCard.innerHTML = `<strong>${player.name}</strong><br/>Ruolo: <strong>${player.role}</strong>`;
        playersArea.prepend(roleCard); // üëà SEMPRE IN CIMA
    }

    // Rimuovi solo eventuali pulsanti precedenti
    const oldButtons = actionArea.querySelectorAll('.actionBtn, .primary, .muted');
    oldButtons.forEach(el => el.remove());

    const subtitle = document.createElement('div');
    subtitle.className = 'muted';
    subtitle.textContent = 'Seleziona bersaglio:';
    actionArea.appendChild(subtitle);

    // Trova eventuale Lupo Alfa vivo
    const lupoAlfa = players.find(p => p.role === "LUPO ALFA" && p.alive);

    // Costruisci lista bersagli (vivi e diversi da s√© stessi)
    const targets = players.filter(t => t.alive && t.name !== player.name);

    if (targets.length === 0) {
        // Nessun target disponibile
        const btn = document.createElement('button');
        btn.className = 'primary';
        btn.textContent = 'Continua';
        btn.onclick = () => {
            player.acted = true;
            renderNightFirst();
        };
        actionArea.appendChild(btn);
        return;
    }

    targets.forEach(t => {
        const b = document.createElement('button');
        b.className = 'actionBtn';
        b.textContent = t.name;

        b.onclick = () => {
            switch(player.role) {
                case 'JOKER':
                    azioni.JOKER = t.name;
                    log(`üÉè JOKER (${player.name}) sceglie ${t.name}`);
                    break;

                case 'MERETRICE':
                    azioni.MERETRICE = t.name;
                    log(`üíã MERETRICE (${player.name}) sceglie ${t.name}`);
                    break;

                case 'VEGGENTE':
                    azioni.VEGGENTE = t.name;
                    log(`üîÆ VEGGENTE (${player.name}) sceglie ${t.name}`);
                    break;

                case 'GUFO':
                    gufato = t.name;
                    log(`üëÅÔ∏è GUFO (${player.name}) sceglie ${t.name}`);
                    break;

                case 'LUPO':
                    // LUPO normale pu√≤ agire
                    azioni.LUPO = t.name;
                    log(`üê∫ LUPO (${player.name}) sceglie ${t.name}`);
                    break;

                case 'LUPO ALFA':
                    // LUPO ALFA sceglie normalmente
                    azioni.LUPO = t.name; // salva come LUPO per la risoluzione notturna
                    log(`üê∫ LUPO ALFA (${player.name}) sceglie ${t.name}`);
                    break;
            }

            // Segna che il giocatore ha agito e aggiorna UI
            player.acted = true;
            renderNightFirst();
        };

        actionArea.appendChild(b);
    });
}

//=====================
//	AVVIO FASE 2 NOTTE : SCREEN-> RESET PULSANTI-> RISOLVI AZIONI-> AVVIA FASE 2
//=====================

function startNightSecond() {
    // 1Ô∏è‚É£ Reset stato acted per tutti i giocatori vivi (fase 2)
    players.forEach(p => p.acted = false);

    // 2Ô∏è‚É£ Snapshot dei giocatori vivi
    nightPlayersSnapshot = players.filter(p => p.alive);

    // 3Ô∏è‚É£ Risolvi azioni della notte (LUPO, MERETRICE, VEGGENTE, GUFO, JOKER)
    resolveNightActionsFull();

    // 4Ô∏è‚É£ Mostra UI fase 2
    renderNightSecond();
}

//=====================
//	FASE 2 DELLA NOTTE: DEFINIZIONE DEI MESSAGGI DI RISPOSTA
//=====================

function showSecondInfoFor(player){
    playersArea.innerHTML = '';
    actionArea.innerHTML = '';
    timerDiv.textContent = '';
    nightState.textContent = `FASE: INFORMAZIONI ‚Äî ${player.name}`;

    let infoMsg = MSG_NO_INFO;

    //=====================
    // VEGGENTE
    //=====================
    switch(player.role) {
        case "VEGGENTE":
            if (player.infoMsg !== MSG_NO_ACTION && azioni.VEGGENTE) {
                const bersaglio = findPlayer(azioni.VEGGENTE);
                if (bersaglio) {
                    infoMsg = ruoliMannari.includes(bersaglio.role)
                        ? `${bersaglio.name} √à UN MANNARO`
                        : `${bersaglio.name} NON √à UN MANNARO`;
                }
            }
            break;

    //=====================
    //	MEDIUM
    //=====================

        case "MEDIUM":
            if (player.infoMsg !== MSG_NO_ACTION) {
                if (!ultimoRogo) {
                    infoMsg = MSG_NO_DEAD_AT_ROGO;
                } else {
                    const morto = findPlayer(ultimoRogo);
                    if (morto) {
                        infoMsg = `AL ROGO √à MORTO ${morto.name}. ERA ${ruoliMannari.includes(morto.role) ? "UN MANNARO" : "UN NON MANNARO"}`;
                    }
                }
            }
            break;
    //=====================
    //	MEDIUM
    //=====================

        case "GUFO":
            if (player.infoMsg === MSG_NO_ACTION) {
                infoMsg = MSG_NO_ACTION; // silenziato o azione annullata
            } else if (gufato) {
                const bersaglio = findPlayer(gufato);
                if (bersaglio && bersaglio.alive) {
                    infoMsg = MSG_NO_INFO; // azione riuscita, ma nessuna info extra
                }
            }
            break;

    //=====================
    //	SE HANNO ESEGUITO L'AZIONE REGOLARMENTE (JOKER,MERETRICE,LUPO)
    //=====================

        default:
            if (player.infoMsg === MSG_NO_ACTION) {
                infoMsg = MSG_NO_ACTION;
            } else {
                infoMsg = MSG_NO_INFO;
            }
            break;
    }

//=====================
//	SALVA E MOSTRA
//=====================
    player.infoMsg = infoMsg;

    const info = document.createElement('div');
    info.className = 'card';
    info.innerHTML = `<strong>${player.name}</strong><br/>${infoMsg}`;
    actionArea.appendChild(info);

    startCountdown(3, () => {
        player.acted = true;
        renderNightSecond();
    });
}

//=====================
//	FASE 2 DELLA NOTTE: GESTIONE DEL TIMER QUANDO OTTIENI LE INFORMAZIONI
//=====================

function startCountdown(seconds, cb){
  timerDiv.textContent = `Tempo restante: ${seconds}s`;
  let c = seconds;
  const id = setInterval(()=>{
    c--;
    timerDiv.textContent = `Tempo restante: ${c}s`;
    if(c<=0){ clearInterval(id); timerDiv.textContent=''; cb(); }
  },1000);
}

//=====================
//	FASE 1 GIORNO: UI DEL GIORNO
//=====================

function startDay(){
  phase = 'day_first';
  daySection.style.display='block';
  recapNightSection.style.display='none';
  nightSection.style.display='none';
  recapRogoSection.style.display='none';
  dayState.textContent = 'CLICCA IL TUO NOME'
  document.getElementById('dayNum').textContent = dayNum;
  votiGiorno = {};
  ballotaggio = [];
  inSecondBallot = false;
  vincitorePrimo = null;
  // note: gufato √® gi√† impostato in notte se il GUFO ha agito
  renderPlayerVoteButtons();
  updateVoteInfo();
}

//=====================
//	FASE 1-2 GIORNO: UI CHE SPIEGA CHI PUOI VOTARE
//=====================

function updateVoteInfo(){
  if(phase === 'day_first'){
    voteInfo.textContent = `PRIMO SONDAGGIO: NON PUOI VOTARE IL GUFATO (${gufato ? gufato : 'nessuno'})`;
  } else if(phase === 'day_second'){
    voteInfo.textContent = `BALLOTTAGGIO: CHI VUOI MANDARE AL ROGO (${ballotaggio.join(', ')})`;
  } else {
    voteInfo.textContent = '';
  }
}

//=====================
//	FASE 1-2 GIORNO: UI CHE GESTISCE CHI DEVE ANCORA VOTARE E CHI DEVE VOTARE
//=====================

function renderPlayerVoteButtons() {
  playersDay.innerHTML = '';
  voteArea.innerHTML = '';
  dayState.textContent = DAY_TEXT.SELECT_PLAYER;
  btnCalcolaVoti.style.display = 'none';

  let voters;
  if(!inSecondBallot){
    // PRIMO SONDAGGIO: solo giocatori vivi, escluse persone che hanno gi√† votato e il gufato
    voters = players.filter(p => p.alive && !(p.name in votiGiorno) && p.name !== gufato);
  } else {
    // SECONDO BALLOTTAGGIO: solo i candidati rimasti non votanti
    voters = players.filter(p => p.alive && !ballotaggio.includes(p.name) && !(p.name in votiGiorno));
  }

  // Mostra pulsanti solo per i votanti corretti
  if(voters.length === 0){
    if(Object.keys(votiGiorno).length > 0){
      btnCalcolaVoti.style.display = 'inline-block';
    }
    updateVoteInfo();
    return;
  }

  voters.forEach(v => {
    const b = document.createElement('button');
    b.className = 'playerBtn';
    b.textContent = v.name;
    b.onclick = () => showVoteOptionsFor(v);
    playersDay.appendChild(b);
  });

  updateVoteInfo();
}

//=====================
//	FASE 1-2 GIORNO: UI CHE GESTISCE CHI DEVE ANCORA VOTARE E CHI DEVE VOTARE
//=====================

function showVoteOptionsFor(voter){
  playersDay.innerHTML=''; voteArea.innerHTML=''; btnCalcolaVoti.style.display='none';
  dayState.textContent = DAY_TEXT.VOTO;
  currentVoter = voter.name;
  // determinare le opzioni votabili in base alla fase
  let options = [];
  if(!inSecondBallot){
    // primo sondaggio: tutti gli alive tranne s√© stessi e il gufato
    options = players.filter(p=>p.alive && p.name !== voter.name && p.name !== gufato).map(p=>p.name);
  } else {
    // secondo ballot: possono votare solo i candidati (ballotaggio)
    options = ballotaggio.slice().filter(n => n !== voter.name);
  }

  options.forEach(opt=>{
    const btn = document.createElement('button'); btn.className='actionBtn'; btn.textContent = opt;
    btn.onclick = ()=>{
      votiGiorno[voter.name] = opt;
      renderPlayerVoteButtons();
    };
    voteArea.appendChild(btn);
  });
}

//=====================
//	FASE 1-2 GIORNO: LOGICA SUL CALCOLO DI VOTO E CHI DEVE ANDARE AL ROGO
//=====================

btnCalcolaVoti.onclick = ()=> { computeVotes(); };

function computeVotes() {
    // Conta i voti
    const tally = {};
    players.filter(p => p.alive).forEach(p => tally[p.name] = 0);
    Object.values(votiGiorno).forEach(v => {
        if (tally[v] !== undefined) tally[v]++;
    });

    const anyVotes = Object.values(tally).some(c => c > 0);
    if (!anyVotes) {
        btnCalcolaVoti.style.display = 'none';
        return;
    }

    // Trova il massimo dei voti e i candidati corrispondenti
    const maxV = Math.max(...Object.values(tally));
    let topCandidates = Object.keys(tally).filter(k => tally[k] === maxV);

    // Primo turno (non ballot)
    if (!inSecondBallot) {

        // Se non c‚Äô√® gufato ‚Üí unica votazione
        if (!gufato) {
            if (topCandidates.length === 1) {
                eliminatePlayer(topCandidates[0], 'rogo');
            } else {
                // pareggio ‚Üí elimina uno casualmente
                const randomIndex = Math.floor(Math.random() * topCandidates.length);
                eliminatePlayer(topCandidates[randomIndex], 'rogo_pareggio');
            }
            return;
        }

        // C'√® gufato ‚Üí escludi gufato dai topCandidates
        topCandidates = topCandidates.filter(n => n !== gufato);

        // Controlla quanti candidati rimangono vivi
        const aliveCandidates = topCandidates.filter(n => findPlayer(n)?.alive);

        if (aliveCandidates.length === 1) {
            // Solo un candidato vivo ‚Üí secondo ballot con gufato
            ballotaggio = [aliveCandidates[0], gufato].filter(n => findPlayer(n)?.alive);

            // Se rimane solo un candidato ‚Üí elimina direttamente
            if (ballotaggio.length === 1) {
                eliminatePlayer(ballotaggio[0], 'rogo_secondo_ballottaggio');
                return;
            } else if (ballotaggio.length === 0) {
                showRecapRogoNoElimination([]);
                return;
            }

            inSecondBallot = true;
            votiGiorno = {};
            phase = 'day_second';
            updateVoteInfo();
            renderPlayerVoteButtons();
            return;

        } else if (aliveCandidates.length > 1) {
            // Pareggio tra pi√π candidati ‚Üí secondo ballot tra loro
            ballotaggio = aliveCandidates.slice();
            inSecondBallot = true;
            votiGiorno = {};
            phase = 'day_second';
            updateVoteInfo();
            renderPlayerVoteButtons();
            return;
        } else {
            // Nessun candidato vivo ‚Üí niente eliminazione
            showRecapRogoNoElimination([]);
            return;
        }
    }

    // Secondo ballot
    if (inSecondBallot) {
        const aliveCandidates = ballotaggio.filter(n => findPlayer(n)?.alive);
        if (aliveCandidates.length <= 1) {
            // Solo uno rimasto ‚Üí va al rogo
            eliminatePlayer(aliveCandidates[0], 'rogo_secondo_ballottaggio');
        } else {
            // Due candidati ‚Üí verifica pareggio
            const votes1 = Object.values(votiGiorno).filter(v => v === aliveCandidates[0]).length;
            const votes2 = Object.values(votiGiorno).filter(v => v === aliveCandidates[1]).length;

            if (votes1 === votes2) {
                // Pareggio ‚Üí va al rogo il gufato
                if (gufato && findPlayer(gufato)?.alive) {
                    eliminatePlayer(gufato, 'rogo_pareggio_secondo_ballottaggio');
                }
            } else {
                // Chi ha pi√π voti va al rogo
                const toEliminate = votes1 > votes2 ? aliveCandidates[0] : aliveCandidates[1];
                eliminatePlayer(toEliminate, 'rogo_secondo_ballottaggio');
            }
        }
    }
}


//=====================
//	RECAP NOTTE : MORTO E GUFATO + CONTROLLO VITTORIA
//=====================

function showNightRecap() {
    // Nascondi notte e mostra recap
    nightSection.style.display = 'none';
    recapNightSection.style.display = 'block';
    recapNightCard.innerHTML = '';

    // 1Ô∏è‚É£ Mostra morti della notte
    if (mortiFaseNotte.length) {
        const d = document.createElement('div');
        d.className = 'card';
        d.innerHTML = `<strong>üíÄ MORTI DELLA NOTTE:</strong> ${mortiFaseNotte.join(', ')}`;
        recapNightCard.appendChild(d);
    } else {
        const d = document.createElement('div');
        d.className = 'card';
        d.textContent = 'NESSUNA VITTIMA NELLA NOTTE.';
        recapNightCard.appendChild(d);
    }

    // 2Ô∏è‚É£ Mostra gufate
    const d = document.createElement('div');
    d.className = 'card';

    if (gufato) {
        const t = findPlayer(gufato);
        if (t && t.alive) {
            d.innerHTML = `<strong>üëÅÔ∏è GUFO HA PUNTATO SU:</strong> ${t.name}`;
        } else {
            d.textContent = 'üëÅÔ∏è NESSUN GUFATO.';
        }
    } else {
        d.textContent = 'üëÅÔ∏è NESSUN GUFATO.';
    }

    recapNightCard.appendChild(d);

    // 3Ô∏è‚É£ Controllo vittoria subito dopo la notte
    if (controllaFinePartita()) return;

    // 4Ô∏è‚É£ Prepara azioni per il giorno: reset temporanei
    azioni = {};
    protezioni = {};
    // mortiFaseNotte rimane per log e medium
}

//=====================
//	ELIMINAZIONE E RECAP ROGO + CONTROLLO VITTORIA
 //=====================

function eliminatePlayer(name, reason) {
    const p = findPlayer(name);
    if (!p) return;

    // Segna il giocatore come morto
    p.alive = false;
    ultimoRogo = p.name;
    log(`üíÄ ${p.name} √® stato eliminato (${reason})`);

    // Reset voti e ballottaggio
    ballotaggio = [];
    inSecondBallot = false;
    votiGiorno = {};

    // Controllo vittoria immediato
    if (controllaFinePartita()) return;

    // Mostra recap rogo
    daySection.style.display = 'none';
    recapRogoSection.style.display = 'block';
    recapRogoCard.innerHTML = `<div class="card">üíÄ AL ROGO √à MORTO: <strong>${name}</strong></div>`;
}

function showRecapRogoNoElimination(tiedList) {
    daySection.style.display = 'none';
    recapRogoSection.style.display = 'block';
    recapRogoCard.innerHTML = `<div class="card">üîî Pareggio nel secondo ballottaggio tra: ${tiedList.join(', ')}. <strong>Nessuna eliminazione</strong>.</div>`;

    // Reset ballottaggio e voti
    ballotaggio = [];
    inSecondBallot = false;
    votiGiorno = {};
}

//=====================
//	DOPO IL CONTINUA TORNA LA NOTTE CON AGGIORNAMENTO PER NUMERO NOTTE
//=====================

continueToNightBtn.onclick = () => {
    recapRogoSection.style.display = 'none';

    // Incrementa la notte
    nightNum++;
    updateTitles();

    // Reset stato notte
    players.forEach(p => {
        p.acted = false;
        p.infoMsg = null; // ‚úÖ RESET INFO QUI
    });

    azioni = {};
    protezioni = {};
    mortiFaseNotte = [];
    gufato = null;

    // üîπ CONTROLLO LUPO ALFA
    const lupoAlfa = players.find(p => p.role === "LUPO ALFA" && p.alive);
    if (!lupoAlfa) {
        // LUPO ALFA √® morto ‚Üí LUPO normale diventa un actionRole
        if (!actionRoles.includes("LUPO")) actionRoles.push("LUPO");
    }

    // ‚úÖ Pulisci snapshot della notte precedente
    nightPlayersSnapshot = [];

    nightSection.style.display = 'block';
    renderNightFirst();
};

//=====================
//	DOPO IL CONTINUA TORNA IL GIORNO CON AGGIORNAMENTO PER NUMERO GIORNO
//=====================

continueToDayBtn.onclick = ()=>{
  recapNightSection.style.display = 'none';
  startDay();
};

//=====================
//	FASE 1-2 NOTTE: LOGICHE PER TUTTE LE AZIONI
//=====================

function resolveNightActionsFull() {
    // Reset stati
    silenziato = null;
    protezioni = {};
    mortiFaseNotte = [];
    graveLog = [];

    // Trova ruoli vivi
JOKER = players.find(p => p.role === "JOKER" && p.alive) || null;
MERETRICE = players.find(p => p.role === "MERETRICE" && p.alive) || null;
VEGGENTE = players.find(p => p.role === "VEGGENTE" && p.alive) || null;
GUFO = players.find(p => p.role === "GUFO" && p.alive) || null;
LUPO = players.find(p =>
    (p.role === "LUPO" || p.role === "LUPO ALFA") && p.alive
) || null;
let jokerSilenzioAnnullato = false;

//=====================
//	1Ô∏è‚É£ JOKER
//=====================

if (azioni.JOKER && JOKER) {
    const target = azioni.JOKER;

    if (azioni.MERETRICE === target) {
        jokerSilenzioAnnullato = true;
        log(`‚õî JOKER (${JOKER.name}) tenta di silenziare ${target}, ma la protezione lo annulla`);
    } else {
        silenziato = target;
        log(`üÉè JOKER (${JOKER.name}) silenzia ${target}`);
    }
}

//=====================
//	2Ô∏è‚É£ MERETRICE
//=====================

if (azioni.MERETRICE && MERETRICE) {
    const bersaglio = findPlayer(azioni.MERETRICE);
    const bloccata = silenziato === MERETRICE.name && !jokerSilenzioAnnullato;

    if (bloccata) {
        MERETRICE.infoMsg = MSG_NO_ACTION;
        log(`‚õî MERETRICE (${MERETRICE.name}) √® silenziata e NON pu√≤ pu√≤ proteggere`);
    } else if (bersaglio && bersaglio.alive) {
        protezioni[bersaglio.name] = true;
        log(`üõ°Ô∏è ${bersaglio.name} √® protetto dalla MERETRICE`);
    }
}

//=====================
// 3Ô∏è‚É£ LUPO - LOGICA AGGIORNATA
//=====================

if (azioni.LUPO && LUPO) {
    const target = findPlayer(azioni.LUPO);

    if (silenziato === LUPO.name) {
        // LUPO silenziato ‚Üí non pu√≤ agire
        LUPO.infoMsg = MSG_NO_ACTION;
        log(`‚õî LUPO (${LUPO.name}) √® silenziato e NON pu√≤ attaccare`);

    } else if (target && target.alive) {

        // üö® Nuova regola speciale: se LUPO attacca la MERETRICE
        if (target.role === "MERETRICE") {
            // 1Ô∏è‚É£ La MERETRICE muore
            target.alive = false;
            mortiFaseNotte.push(target.name);
            graveLog.push(target.name);
            log(`üê∫ LUPO (${LUPO.name}) uccide la MERETRICE (${target.name})`);

            // 2Ô∏è‚É£ Tutti i giocatori protetti dalla MERETRICE muoiono anch‚Äôessi
            Object.keys(protezioni).forEach(nomeProtetto => {
                const protetto = findPlayer(nomeProtetto);
                if (protetto && protetto.alive) {
                    protetto.alive = false;
                    mortiFaseNotte.push(protetto.name);
                    graveLog.push(protetto.name);
                    log(`üíÄ Protezione annullata: ${protetto.name} muore a causa della MERETRICE`);
                }
            });

            // 3Ô∏è‚É£ Svuota le protezioni (gi√† morte)
            protezioni = {};
        }

        // Regola normale per altri bersagli
        else if (target.role === "CRICETO") {
            LUPO.infoMsg = MSG_NO_ACTION;
            log(`üêπ CRICETO (${target.name}) √® immune all'attacco del LUPO`);

        } else if (protezioni[target.name]) {
            LUPO.infoMsg = MSG_NO_ACTION;
            log(`üõ°Ô∏è Attacco del LUPO annullato: ${target.name} era protetto`);

        } else {
	    // Attacco standard con gestione vite multiple
	    if(target.lives > 1){
	        target.lives--;       // perde 1 vita
	        log(`üê∫ ${target.name} subisce danno, vite rimaste: ${target.lives}`);
	    } else {
	        target.alive = false; // muore
	        mortiFaseNotte.push(target.name);
	        graveLog.push(target.name);
	        log(`üê∫ LUPO (${LUPO.name}) uccide ${target.name}`);
	    }
	}

    }
}

//=====================
//	4Ô∏è‚É£ VEGGENTE
//=====================

if (azioni.VEGGENTE && VEGGENTE) {
    if (silenziato === VEGGENTE.name) {
        // Il veggente √® silenziato ‚Üí non pu√≤ agire
        VEGGENTE.infoMsg = MSG_NO_ACTION;
        log(`‚õî VEGGENTE (${VEGGENTE.name}) √® silenziato e NON pu√≤ agire`);
    } else {
        const bersaglio = findPlayer(azioni.VEGGENTE);
        if (bersaglio) {
            if (protezioni[bersaglio.name]) {
                // Il bersaglio √® protetto ‚Üí il veggente non pu√≤ fare nulla
                VEGGENTE.infoMsg = MSG_NO_ACTION;
                azioni.VEGGENTE = null;
                log(`üõ°Ô∏è VEGGENTE (${VEGGENTE.name}) ha tentato di agire su ${bersaglio.name}, ma era protetto`);
            } else {
                // Nessuna protezione ‚Üí logica normale
                if (bersaglio.role === "CRICETO" && bersaglio.alive) {
                    bersaglio.alive = false;
                    mortiFaseNotte.push(bersaglio.name);
                    graveLog.push(bersaglio.name);
                    log(`üíÄ VEGGENTE (${VEGGENTE.name}) ha ucciso il CRICETO (${bersaglio.name})`);
                } else {
                    // Il bersaglio non √® CRICETO ‚Üí log dell'azione normale
                    log(`üîÆ VEGGENTE (${VEGGENTE.name}) ha agito su ${bersaglio.name}`);
                }
            }
        } 
      }  
    }


//=====================
//	5Ô∏è‚É£ GUFO
//=====================

if (GUFO && GUFO.alive) {
    if (silenziato === GUFO.name) {
        GUFO.infoMsg = MSG_NO_ACTION;   // ‚Üê questo √® il messaggio corretto
        log(`‚õî GUFO (${GUFO.name}) √® silenziato e NON pu√≤ gufare`);
        gufato = null;                  // ‚Üê azzera il gufato, nessun target valido
    } else if (gufato) {
        const bersaglio = findPlayer(gufato);
        if (bersaglio && protezioni[gufato]) {
            GUFO.infoMsg = MSG_NO_ACTION;   // ‚Üê anche qui il GUFO non pu√≤ agire
            log(`üõ°Ô∏è GUFO (${GUFO.name}) ha tentato di gufare ${gufato}, ma era protetto`);
            gufato = null;                  // azzera il target, protezione annulla l'azione
        } else if (bersaglio) {
            GUFO.infoMsg = MSG_NO_INFO;     // GUFO agisce normalmente
            log(`ü¶â GUFO (${GUFO.name}) ha gufato su ${gufato}`);
        }
    } else {
        GUFO.infoMsg = MSG_NO_ACTION;       // Nessun target ‚Üí niente azione
    }
}

//=====================
//	6Ô∏è‚É£ MEDIUM
//=====================

players.forEach(p => {
    if (p.role === "MEDIUM" && p.alive) {
        if (silenziato === p.name) {
            // Il medium √® silenziato ‚Üí non pu√≤ agire
            p.infoMsg = MSG_NO_ACTION;
            log(`‚õî MEDIUM (${p.name}) √® silenziato e NON pu√≤ ottenere informazioni`);
        } else {
            // Azione normale del medium
            log(`üîÆ MEDIUM (${p.name}) ${MSG_ACTION}`);
         }
     }
 });
}

//=====================
//	START
//=====================

startBtn.onclick = () => {
    names = allNames.slice(0,7).map(n => n.toUpperCase());
    const inputs = extraPlayersDiv.querySelectorAll('input');
    inputs.forEach(inp => {
        if(inp.value.trim() !== ''){
            names.push(inp.value.trim().toUpperCase());
        }
    });

    if(names.length !== selectedPlayerCount){
        alert("Inserisci tutti i nomi!");
        return;
    }

    setupRolesByPlayerCount(names.length);

    // Nascondo la sezione dei nomi
    playerCountSection.style.display = 'none';
    extraPlayersDiv.style.display = 'none';
    startBtn.style.display = 'none';

    // ‚úÖ Creo overlay intermedio
    const overlay = document.createElement('div');
    overlay.id = 'preGameOverlay';
    overlay.style = `
        position: fixed;
        top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: #fff;
        font-family: Arial, sans-serif;
        padding: 20px;
        text-align: center;
    `;
    overlay.innerHTML = `
        <h2>CONOSCI TUTTI GLI EFFETTI DEI PERSONAGGI</h2>
        <div style="margin-top:20px; display:flex; flex-direction:column; gap:15px; width:100%; max-width:300px;">
            <button id="startGameBtn" style="padding:15px; font-size:18px; font-weight:bold; border:none; border-radius:12px; background:#0ea5a4; color:#042024; cursor:pointer;">INIZIA PARTITA</button>
            <button id="explainRolesBtn" style="padding:15px; font-size:18px; font-weight:bold; border:none; border-radius:12px; background:#1e293b; color:#e6eef6; cursor:pointer;">SPIEGAMI I RUOLI</button>
        </div>
    `;
    document.body.appendChild(overlay);

//=====================
//	PULSANTE INIZIA
//=====================

    document.getElementById('startGameBtn').onclick = () => {
        overlay.remove();           // chiude overlay
        assignRoles();              // assegna ruoli
        logRoleDistribution();      // log dei ruoli (se usi)
        renderNightFirst();         // parte la prima notte
    };

//=====================
//	PULSANTE SPIEGAMI I RUOLI
//=====================

    document.getElementById('explainRolesBtn').onclick = () => {
        overlay.remove();                    // chiude overlay
        const roleInfoSection = document.getElementById('roleInfoSection');
        roleInfoSection.style.display = 'block';

        const roleList = document.getElementById('roleList');
        roleList.innerHTML = '';
        baseRoles.forEach(r => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${r}</strong>: ${ruoloDescrizioni[r] || "Nessuna descrizione"}`;
            roleList.appendChild(li);
        });
    };
};

//=====================
//	PULSANTE INIZIA PARTITA DOPO SPIEGAZIONE RUOLI
//=====================

const confirmRolesBtn = document.getElementById('confirmRolesBtn');

confirmRolesBtn.onclick = () => {
    // 1Ô∏è‚É£ Nasconde overlay / schermata ruoli
    const overlay = document.getElementById('preGameOverlay');
    if (overlay) overlay.remove(); // se esiste lo elimina

    const roleInfoSection = document.getElementById('roleInfoSection');
    if (roleInfoSection) roleInfoSection.style.display = 'none';

    // 2Ô∏è‚É£ Avvia la partita
    assignRoles();         // assegna i ruoli ai player
    logRoleDistribution(); // opzionale
    renderNightFirst();    // parte la NOTTE
};

//=====================
//	PER ATTIVARE I LOG METTERE BLOCK
//=====================

    // Nascondi sezione iniziale
    document.getElementById('logContainer').style.display = 'none';

//=====================
//	CONTROLLO VINCITA
//=====================

function controllaFinePartita() {
    let buoniVivi = players.filter(p => p.alive && ruoloBuoni.includes(p.role));
    let cattiviVivi = players.filter(p => p.alive && ruoloCattivi.includes(p.role));
    let LUPOVivo = players.find(p => (p.role === "LUPO" || p.role === "LUPO ALFA") && p.alive);
    let CRICETOVivo = players.find(p => p.role === "CRICETO" && p.alive);

    let vincita = null;

    // Cattivi vincono se il lupo √® vivo e i cattivi > buoni
    if (LUPOVivo && cattiviVivi.length > buoniVivi.length) {
        vincita = "CATTIVI";
    } 
    // Cattivi vincono se il lupo √® vivo ma resta solo 1 buono
    else if (LUPOVivo && buoniVivi.length === 1) {
        vincita = "CATTIVI";
    } 
    // Buoni vincono se il lupo √® morto e ci sono pi√π di 1 buoni vivi
    else if (!LUPOVivo && buoniVivi.length >= 1) {
        vincita = "BUONI";
    }

    // CRICETO ruba la vittoria se √® vivo
    if (vincita && CRICETOVivo) {
        mostraVittoria(`üèÜ CRICETO √à VIVO (${CRICETOVivo.name}) RUBA LA VITTORIA AI ${vincita}!`);
        return true;
    }

    // Vittoria normale
    if (vincita) {
        mostraVittoria(`üèÜ I ${vincita} VINCONO!`);
        return true;
    }

    return false; // Partita continua
}

//=====================
//	MOSTRA VITTORIA
//=====================

function mostraVittoria(messaggio){
    const endScreen = document.getElementById("endGameScreen");
    const winnerBox = document.getElementById("winnerBox");
    const finalLog = document.getElementById("finalLog");

    // testo vincitore
    winnerBox.textContent = messaggio;

    // copia il log nel log finale
    finalLog.innerHTML = "";
    document.querySelectorAll("#logContent div").forEach(riga => {
        const d = document.createElement("div");
        d.textContent = riga.textContent;
        finalLog.appendChild(d);
    });

    // mostra schermata finale
    endScreen.classList.remove("hidden");

    // nascondi tutto il resto
    nightSection.style.display = 'none';
    recapNightSection.style.display = 'none';
    daySection.style.display = 'none';
    recapRogoSection.style.display = 'none';
    document.querySelector('.app').style.display = 'none';
}

//=====================
//	LOG
//=====================

function log(msg){
  const time = new Date().toLocaleTimeString();
  const logContent = document.getElementById('logContent');
  const div = document.createElement('div');
  div.textContent = `[${time}] ${msg}`;
  logContent.appendChild(div);
  logContent.scrollTop = logContent.scrollHeight;
}

function showEndGame(winner, logFinale) {
    document.getElementById("gameUI").classList.add("hidden");
    document.getElementById("endGameScreen").classList.remove("hidden");

    document.getElementById("winnerBox").textContent =
        `VINCE LA SQUADRA ${winner}`;

    const logDiv = document.getElementById("finalLog");
    logDiv.innerHTML = "";

    logFinale.forEach(riga => {
        const p = document.createElement("div");
        p.textContent = riga;
        logDiv.appendChild(p);
    });
}

document.getElementById("restartBtn").onclick = () => {
    location.reload();
};

</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => {
        console.log('SW registrato!', reg);

        // controlla se c'√® un service worker nuovo pronto
        if (reg.waiting) {
          // manda messaggio per farlo attivare subito
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }

        // quando un nuovo SW √® installato e pronto, avvisa
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('Nuova versione disponibile! Forzo aggiornamento...');
              newWorker.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
      })
      .catch(err => console.error('Errore registrazione SW:', err));

    // ricarica la pagina quando il SW nuovo prende il controllo
    let refreshing;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (refreshing) return;
      window.location.reload();
      refreshing = true;
    });
  });
}
</script>
</body>
</html>
